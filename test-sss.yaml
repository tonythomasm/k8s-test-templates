apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: app
  namespace: ns1
spec:
  serviceName: app
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      tolerations:
      - key: "eks.amazonaws.com/compute-type"
        operator: "Equal"
        value: "fargate"
        effect: "NoSchedule"
      # If running on Fargate, EFS mounts are supported. If on node groups, ensure efs-csi-driver installed.
      containers:
      - name: app
        image: busybox
        env:
        - name: MY_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        command: ["sh", "-c", "echo 'test from statefulsets' > /data/test.txt && sleep 50000"]
        volumeMounts:
        - name: efs
          mountPath: /data
          # subPath ensures each pod uses its own directory
          subPathExpr: pods/$(MY_POD_NAME)
      initContainers:
      - name: init-mkdir
        image: busybox
        env:
        - name: MY_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        command:
          - sh
          - -c
          - |
            set -e
            mkdir -p /data/pods/${MY_POD_NAME}
            chown -R 1001:1001 /data/pods/${MY_POD_NAME}
        securityContext:
          runAsUser: 1001       # MUST match access point POSIX uid
        volumeMounts:
        - name: efs
          mountPath: /data
      volumes:
      - name: efs
        persistentVolumeClaim:
          claimName: pvc-ns1-1
