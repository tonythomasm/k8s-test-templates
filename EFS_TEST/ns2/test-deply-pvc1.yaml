apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-ns2
  namespace: ns2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp-ns2
  template:
    metadata:
      labels:
        app: myapp-ns2
        "eks.amazonaws.com/fargate-profile": "test-tony-eks-fp-ns2"
    spec:
      schedulerName: fargate-scheduler
      tolerations:
      - key: "eks.amazonaws.com/compute-type"
        operator: "Equal"
        value: "fargate"
        effect: "NoSchedule"
      # If running on Fargate, EFS mounts are supported. If on node groups, ensure efs-csi-driver installed.
      containers:
      - name: app
        image: busybox
        command: ["sh", "-c", "echo 'test dummy data' > /data/test.txt && sleep 50000"]
        volumeMounts:
        - name: efs
          mountPath: /data
          # subPath ensures each pod uses its own directory
          subPath: pods/$(HOSTNAME)
      initContainers:
      - name: init-mkdir
        image: busybox
        command:
          - sh
          - -c
          - |
            set -e
            mkdir -p /data/pods/$(hostname)
            # optionally set permissions if needed
            chown -R 1001:1001 /data/pods/$(hostname)
        securityContext:
          runAsUser: 1001       # MUST match access point POSIX uid
        volumeMounts:
        - name: efs
          mountPath: /data
      volumes:
      - name: efs
        persistentVolumeClaim:
          claimName: pvc-ns2-1
